<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MIDI Client</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    background: #0f172a;
    color: #e2e8f0;
    font-family: -apple-system, system-ui;
    padding: 20px;
  }
  h1 { margin-bottom: 0; }
  #log { white-space: pre-wrap; margin-top: 20px; font-size: 0.9rem; }
</style>
</head>
<body>

<h1>ðŸŽ¹ Fibre Cloud â€“ MIDI Client</h1>
<p>This computer will output MIDI into Logic Pro.</p>

<div id="status">Initializingâ€¦</div>
<div id="log"></div>

<script>
const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");

function log(msg) {
  logEl.textContent += msg + "\\n";
  console.log(msg);
}

let midiOut = null;
const PREFERRED_PORT = "IAC Driver FibreBus";  // â† change if needed

// ------------------------------------------------------------
// 1. Enable WebMIDI
// ------------------------------------------------------------
navigator.requestMIDIAccess({ sysex: false })
  .then(onMIDISuccess)
  .catch(err => log("âŒ MIDI init error: " + err));

function onMIDISuccess(midi) {
  log("MIDI access granted.");

  // Find preferred output
  for (let output of midi.outputs.values()) {
    log("Found: " + output.name);
    if (output.name === PREFERRED_PORT) {
      midiOut = output;
    }
  }

  if (!midiOut) {
    log("âŒ Preferred port not found; using first available.");
    midiOut = [...midi.outputs.values()][0];
  }

  if (!midiOut) {
    statusEl.textContent = "âŒ No MIDI outputs available.";
    return;
  }

  // ---- KEY FIX: Explicitly open the output ----
  midiOut.open().then(() => {
    log("ðŸŽ› Output port opened: " + midiOut.name);
    statusEl.textContent = "Connected to MIDI: " + midiOut.name;
  }).catch(err => {
    log("âŒ Failed to open output: " + err);
  });
}

// ------------------------------------------------------------
// 2. WebSocket connection
// ------------------------------------------------------------
const ws = new WebSocket(
  (location.protocol === "https:" ? "wss://" : "ws://") + location.host
);

ws.onopen = () => log("ðŸŸ¢ WebSocket connected.");
ws.onclose = () => log("ðŸ”´ WebSocket disconnected.");
ws.onerror = err => log("âŒ WebSocket error: " + err);

// ------------------------------------------------------------
// 3. Handle incoming taps â†’ send MIDI
// ------------------------------------------------------------
ws.onmessage = event => {
  if (!midiOut) return;

  const msg = JSON.parse(event.data);
  if (msg.type !== "tap") return;

  const x = msg.x;
  const y = msg.y;

  // Pentatonic mapping
  const pent = [0, 2, 4, 7, 9];

  function midiFromX(x) {
    const MIN = 36, MAX = 67, ROOT = 60;
    const scale = [];
    for (let n = MIN; n <= MAX; n++) {
      const dist = n - ROOT;
      const mod = ((dist % 12) + 12) % 12;
      if (pent.includes(mod)) scale.push(n);
    }
    const idx = Math.floor(x * scale.length);
    return scale[Math.max(0, Math.min(idx, scale.length - 1))];
  }

  const note = midiFromX(x);
  const vel = Math.round(40 + (1 - y) * 80);

  log(`â†’ Note ${note} Vel ${vel}`);

  midiOut.send([0x90, note, vel]);
  setTimeout(() => midiOut.send([0x80, note, 0]), 250);
};
</script>
</body>
</html>

